(BLACKWELL ENGINEERING LLC - ETS MACRO SET)
(LENGTH MEASUREMENT CYCLE * V1)
(Modified: 11/2025)


#1=-1                                    (Initialize error code to -1 - no error)
G65P8917M100                            (Call machine constants subroutine)
G65P8917M200                            (Call user start program subroutine)

G40G80G90                               (Cancel cutter compensation, canned cycles, set absolute mode)

N3                                      (Label N3 - Tool number validation section)
#1=1                                    (Set error code to 1 - tool number undefined)
IF[#11NE#0]GOTO5                        (If tool number H parameter is defined, go to N5)
IF[#4111EQ0]GOTO4                       (If variable #4111 is zero, go to N4)
#11=#4111                               (Set tool number from variable #4111)
IF[#11NE0]GOTO5                         (If tool number is not zero, go to N5)
N4IF[#4120EQ0]GOTO7000                  (If variable #4120 is zero, go to error N7000)
#11=#4120                               (Set tool number from variable #4120)
N5IF[#11EQ0]GOTO7000                    (If tool number is still zero, go to error N7000)

IF[#2EQ#0]GOTO9                         (If measurement type parameter D is undefined, go to N9)
#1=4                                    (Set error code to 4 - wrong call parameter)
IF[#2LT0]GOTO7000                       (If D parameter is less than 0, go to error)
IF[#2GT2]GOTO7000                       (If D parameter is greater than 2, go to error)
GOTO10                                  (Go to N10)
N9                                      (Label N9 - Default measurement type)
#2=0                                    (Set default measurement type to 0 - reference measurement)

N10                                     (Label N10 - Tolerance parameter validation)
IF[#17EQ#0]GOTO11                       (If tolerance parameter Q is undefined, go to N11)
#1=4                                    (Set error code to 4 - wrong call parameter)
IF[#17GT2/#100]GOTO7000                 (If tolerance is greater than 2mm, go to error)
IF[#17LT0]GOTO7000                      (If tolerance is negative, go to error)
GOTO12                                  (Go to N12)
N11                                     (Label N11 - Set default tolerance)
#17=#138/#100                           (Set tolerance from machine parameter #138)

N12                                     (Label N12 - Radial offset parameter)
IF[#18NE#0]GOTO13                       (If radial offset parameter R is defined, go to N13)
#18=0                                   (Set default radial offset to 0)
N13                                     (Label N13 - Make radial offset absolute)
#18=ABS[#18]                            (Take absolute value of radial offset)

N20                                     (Label N20 - Tool length calculation section)
#102=#[#134+#11]                        (Get tool length from tool table)
#3=0                                    (Initialize wear value to 0)
IF[#136EQ0]GOTO21                       (If wear table address is 0, skip wear calculation)
#3=#[#136+#11]                          (Get tool wear value from wear table)
N21#12=#102+#3                          (Calculate total tool length - length + wear)

N26                                     (Label N26 - Tool length validation and positioning)
#1=5                                    (Set error code to 5 - wrong tool geometry)
IF[#4008EQ49]GOTO27                     (If tool length compensation is active, skip next line)
G00G49G91Z[#5083+#12]                   (Rapid move to clear position without compensation)
N27G53                                  (Set machine coordinate system)
G00G43G91H#11Z[-#12]                    (Rapid move with tool length compensation)
G90                                     (Set absolute positioning mode)
#22=#12                                 (Store current tool length in variable #22)

N30                                     (Label N30 - Calibration validation section)
#3=#[#139+0]                            (Get calibration value from parameter table)
#3=ABS[#3-#113/#100]                    (Calculate absolute difference from reference Z position)
#1=10                                   (Set error code to 10 - wrong calibration parameters)
IF[#3GT2/#100]GOTO7000                  (If calibration difference > 2mm, go to error)

N40                                     (Label N40 - Coordinate calculation section)
#3=#111/#100+#5041-#5021                (Calculate base X position relative to current work offset)
#4=#112/#100+#5042-#5022                (Calculate base Y position relative to current work offset)
IF[#18EQ0]GOTO45                        (If no radial offset specified, skip radial calculation)
#7=#[5041+#125]-#[5021+#125]            (Calculate current position offset in specified axis)
IF[#125EQ1]GOTO42                       (If Y-axis is radius axis, go to Y calculation)
#3=#111/#100+#7+#126*#18                (Calculate X position with radial offset)
GOTO45                                  (Skip Y calculation)
N42                                     (Y-axis radial offset calculation)
#4=#112/#100+#7+#126*#18                (Calculate Y position with radial offset)
N45                                     (Label N45 - Continue with Z calculations after radial offset)
#10=#127/#100+#5043-#5023-#22           (Calculate safe Z retract position)
#16=#[#139+0]+#12-#22+#5043-#5023       (Calculate probe contact Z position)

N50                                     (Label N50 - Probe activation and positioning)
#20=#120                                (Store measuring feedrate in variable #20)
G40G80G90M05                            (Cancel compensation, canned cycles, absolute mode, stop spindle)
M09                                     (Turn off coolant)
G01G43F[#118/#100]H#11Z#10              (Feed to safe Z position with tool compensation)
IF[#114EQ0]GOTO52                       (If dogleg disabled, go to combined XY move)
IF[#114EQ1]GOTO53                       (If dogleg X first, go to X move)
IF[#114EQ2]GOTO54                       (If dogleg Y first, go to Y move)
GOTO52                                  (Default to combined move if invalid)
N52                                     (Label N52 - Combined XY positioning move)
G01F[#118/#100]X#3Y#4                   (Feed to X,Y probe position in single move)
GOTO56                                  (Skip to probe activation)
N53                                     (Label N53 - Dogleg X first approach)
G01F[#118/#100]X#3                      (Feed X to probe position first)
G01F[#118/#100]Y#4                      (Feed Y to probe position second)
GOTO56                                  (Skip to probe activation)
N54                                     (Label N54 - Dogleg Y first approach)
G01F[#118/#100]Y#4                      (Feed Y to probe position first)
G01F[#118/#100]X#3                      (Feed X to probe position second)
N55                                     (Label N55 - Continue after dogleg moves)
N56                                     (Label N56 - Probe activation)
G65P8917M400                            (Call probe activation subroutine)

N60                                     (Label N60 - Initial probe contact)
#5=#16+#129/#100                        (Calculate initial probe approach position - normal measurement)
IF[#2NE-1]GOTO61                        (If not calibration mode, skip tool length adjustment)
#5=#5-#12                               (For calibration/tool break: subtract tool length)
N61                                     (Label N61 - Execute first probe move)
G31F[#119/#100]Z#5                      (Probe move at positioning feedrate)
#3001=0                                 (Initialize skip signal status)
WHILE[#3001LT0.3]DO1                    (Wait for skip signal to settle)
END1                                    (End of while loop)
IF[[#5063-#16-#129/#100]LE[#130/1000]/#100]GOTO80 (If probe contact within tolerance, continue)
#1=5                                    (Set error code to 5 - start measuring block error)
GOTO500                                 (Go to error handling section)

N80                                     (Label N80 - Probe second contact)
#6=#16+#129/#100                        (Calculate approach position above probe)
G31F[#119/#100]Z#6                      (Probe move at positioning feedrate)
#3001=0                                 (Initialize skip signal status)
WHILE[#3001LT0.3]DO1                    (Wait for skip signal to settle)
END1                                    (End of while loop)
IF[[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO90 (If contact within tolerance, continue)
#1=5                                    (Set error code to 5 - start measuring block error)
GOTO500                                 (Go to error handling section)

N90                                     (Label N90 - Final precision measurement)
#5=#16-#130/#100                        (Calculate final probe position with overtravel allowance)
G31F[#120/#100]Z#5                      (Final probe move at measuring feedrate)
#3001=0                                 (Initialize skip signal status)
WHILE[#3001LT0.3]DO1                    (Wait for skip signal to settle)
END1                                    (End of while loop)
#1=7                                    (Set error code to 7 - measurement without trigger signal)
IF[[#5063-#16+#130/#100-#22]LE[#130/1000]/#100]GOTO500 (Check if contact within tolerance)
#1=6                                    (Set error code to 6 - error start measuring block)
IF[ABS[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO500 (Check measurement validity)
#1=-1                                   (Set no error flag - successful measurement)

N100                                    (Label N100 - Measurement calculation and tool table update)
#3=#141*#120/#100/60                    (Calculate trigger point correction)
#25=#5063-#5043+#5023-#[#139+0]+#3      (Calculate measured tool length)
IF[#2NE0]GOTO150                        (If not reference measurement, go to tolerance check)
N110                                    (Label N110 - Tool table update for reference measurement)
#[#134+#11]=#25                         (Update tool length in tool table)
IF[#136EQ0]GOTO500                      (If no wear table, go to completion)
#[#136+#11]=0                           (Reset wear value to zero)
GOTO500                                 (Go to completion section)

N150                                    (Label N150 - Tolerance checking for wear measurement)
#24=#25-#102                            (Calculate tool wear - difference from reference)
IF[#2EQ2]GOTO160                        (If wear comparison only, skip wear table update)
IF[#136EQ0]GOTO160                      (If no wear table, skip wear update)
#[#136+#11]=#24                         (Update wear value in tool table)
N160                                    (Label N160 - Tool condition evaluation)
#1=9                                    (Set error code to 9 - tool broken)
IF[ABS[#24]GT2*#17]GOTO500              (If wear exceeds 2x tolerance, tool is broken)
#1=8                                    (Set error code to 8 - tool out of tolerance)
IF[ABS[#24]GT#17]GOTO500                (If wear exceeds tolerance, tool needs attention)
#1=-1                                   (Set no error flag - tool is within tolerance)

N500                                    (Label N500 - Completion and cleanup section)
G00G43F[#118/#100]H#11Z#10              (Rapid move to safe retract position)
G65P8917M500                            (Call probe deactivation subroutine)
#108=#1                                 (Store error code for message display)
G65P8917M300                            (Call user end program subroutine)
IF[#1LT0]GOTO9999                       (If no error, go to program end)

N7000                                   (Label N7000 - Error handling section)
G65P8918A#1                             (Call error message display subroutine)

N9999                                   (Label N9999 - Program end)
M99                                     (Return from subroutine)
