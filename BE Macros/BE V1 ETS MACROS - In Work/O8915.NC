(BLACKWELL ENGINEERING - ETS)
(LENGTH MEASUREMENT * VERSION 1 * 01.12.2015)

(ROUTING FOR CUSTOM PROBE LENGTH SETTING)
IF[#4120NE99]GOTO1 (IF PROBE LENGTH NOT 99, GOTO MAIN ROUTINE)
M98 P0725 (SET PROBE LENGTH ON CALIBRATION ARTIFACT)
GOTON9999 (RETURN TO END)

N1 (MAIN ROUTINE START)
#1=-1 (INITIALIZE ERROR CODE TO -1 (NO ERROR))
G65P8917M100 (CALL O8917 MACRO - MACHINE CONSTANTS)
G65P8917M200 (CALL O8917 MACRO - USER START PROGRAM)

G40G80G90 (CANCEL TOOL OFFSET, CANNED CYCLE, SET ABSOLUTE MODE)

N3 (TOOL VALIDATION)
#1=1 (SET ERROR CODE TO 1)
IF[#11NE#0]GOTO5 (IF TOOL NUMBER ALREADY SET, SKIP)
IF[#4111EQ0]GOTO4 (IF PARAMETER #4111 NOT SET, GOTO N4)
#11=#4111 (ASSIGN TOOL NUMBER FROM #4111)
IF[#11NE0]GOTO5 (IF TOOL NUMBER SET, SKIP)
N4IF[#4120EQ0]GOTO7000 (IF PARAMETER #4120 NOT SET, ERROR)
#11=#4120 (ASSIGN TOOL NUMBER FROM #4120)
N5IF[#11EQ0]GOTO7000 (IF TOOL NUMBER STILL ZERO, ERROR)

(MEASUREMENT TYPE VALIDATION)
IF[#2EQ#0]GOTO9 (IF #2 NOT SET, DEFAULT TO 0)
#1=4 (SET ERROR CODE TO 4)
IF[#2LT0]GOTO7000 (IF #2 LESS THAN 0, ERROR)
IF[#2GT2]GOTO7000 (IF #2 GREATER THAN 2, ERROR)
GOTO10 (SKIP DEFAULT)
N9 (DEFAULT)
#2=0 (SET #2 TO REFERENCE MEASUREMENT MODE)

N10 (RADIAL OFFSET PARAMETER VALIDATION)
IF[#17EQ#0]GOTO11 (IF #17 NOT SET, DEFAULT TO #138/#100)
#1=4 (SET ERROR CODE TO 4)
IF[#17GT2/#100]GOTO7000 (IF #17 TOO LARGE, ERROR)
IF[#17LT0]GOTO7000 (IF #17 NEGATIVE, ERROR)
GOTO12 (SKIP DEFAULT)
N11 (DEFAULT OFFSET)
#17=#138/#100 (SET #17 TO TOOL WEAR TOLERANCE)

N12 (RADIAL OFFSET SIGN VALIDATION)
IF[#18NE#0]GOTO13 (IF #18 NOT SET, DEFAULT TO 0)
#18=0 (DEFAULT: NO SIGN MODIFIER)
N13 (TAKE ABSOLUTE VALUE)
#18=ABS[#18] (CONVERT #18 TO POSITIVE VALUE)

N20 (TOOL LENGTH CALCULATION)
#102=#[#134+#11] (READ TOOL LENGTH FROM MEMORY AT OFFSET #134+TOOL#)
#3=0 (INITIALIZE WEAR OFFSET TO 0)
IF[#136EQ0]GOTO21 (IF NO WEAR MEMORY OFFSET, SKIP)
#3=#[#136+#11] (READ TOOL WEAR VALUE FROM MEMORY)
N21#12=#102+#3 (CALCULATE TOTAL TOOL LENGTH WITH WEAR)
IF[#12NE0]GOTO26 (IF TOOL LENGTH CALCULATED, PROCEED)

N26 (TOOL LENGTH VALIDATION)
#1=5 (SET ERROR CODE TO 5 - WRONG GEOMETRY)
IF[#12GT#131/#100]GOTO7000 (IF TOOL LENGTH EXCEEDS MAX, ERROR)
IF[#12LT#132/#100]GOTO7000 (IF TOOL LENGTH BELOW MIN, ERROR)
IF[#4008EQ49]GOTO27 (IF SPINDLE AT POSITION 49, SKIP RAPID)
G53G00G49G90Z[18.8976] (RAPID TO SAFE Z IN MACHINE COORDINATES)
N27G53 (OFFSET CANCEL)
G00G43G91H#11Z[-#12] (RAPID TO TOOL LENGTH OFFSET POSITION)
G90 (RETURN TO ABSOLUTE MODE)
#22=#12 (STORE TOOL LENGTH IN #22)

N30 (CALIBRATION OFFSET CHECK)
#3=#[#139+0] (READ CALIBRATION OFFSET VALUE)
#3=ABS[#3-#113/#100] (CALCULATE DEVIATION FROM REFERENCE Z)
#1=10 (SET ERROR CODE TO 10)
IF[#3GT2/#100]GOTO7000 (IF DEVIATION EXCEEDS TOLERANCE, ERROR)

N40 (POSITION CALCULATION)
#3=#111/#100+#5041-#5021 (CALCULATE X POSITION: OFFSET + CURRENT - REFERENCE)
#4=#112/#100+#5042-#5022 (CALCULATE Y POSITION: OFFSET + CURRENT - REFERENCE)
#10=#127/#100+#5043-#5023-#22 (CALCULATE Z RAPID POSITION TO PROBE)
#16=#[#139+0]+#12-#22+#5043-#5023 (CALCULATE MEASUREMENT Z START HEIGHT)

N50 (MOVE TO MEASUREMENT POSITION)
#20=#120 (STORE MEASURING FEEDRATE)
M8 (TURN ON COOLANT)
G40G80G90M05 (CANCEL OFFSETS, CANNED CYCLES, ABSOLUTE, SPINDLE OFF)
G00G43H#11Z#10 (RAPID TO Z WITH TOOL OFFSET)
G00X#3Y#4 (RAPID TO X,Y POSITION)
G65P8917M400 (CALL O8917 MACRO - PROBE ON SEQUENCE)

N51 (FIRST MEASUREMENT APPROACH)
#5=#16+#129/#100+#131/#100-#12 (CALCULATE UPPER LIMIT Z WITH SAFETY DISTANCE)
G31F[#119/#100]Z#5 (POSITIONING FEEDRATE PROBE TO UPPER LIMIT)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO1 (WAIT FOR PROBE SIGNAL)
END1 (END WAIT LOOP)
IF[[#5063-#16-#129/#100-#131/#100]LE[#130/1000]/#100]GOTO52 (IF MEASUREMENT IN TOLERANCE, PROCEED)
#1=5 (SET ERROR CODE TO 5 - PROBE SIGNAL ISSUE)
GOTO500 (ERROR HANDLER)

N52 (RADIAL OFFSET SETUP)
IF[#18EQ0]GOTO60 (IF NO RADIAL OFFSET, SKIP TO SINGLE TOOTH)
#15=#125+#126 (CALCULATE AXIS/SIDE COMBINATION)
#19=0 (INITIALIZE SPINDLE ROTATION ANGLE)
IF[#15EQ1]GOTO53 (IF SPECIFIC COMBINATION, SKIP)
#19=-270 (DEFAULT ROTATION ANGLE 1)
IF[#15EQ0]GOTO53 (IF SPECIFIC COMBINATION, SKIP)
#19=-90 (ALTERNATIVE ROTATION ANGLE)
IF[#15EQ2]GOTO53 (IF SPECIFIC COMBINATION, SKIP)
#19=-180 (ALTERNATIVE ROTATION ANGLE)

N53 (RADIAL MEASUREMENT SETUP)
M19 R#19 (ORIENT SPINDLE TO ANGLE #19)
#3=#[5041+#125]-#[5021+#125] (GET POSITION OFFSET FOR SELECTED AXIS)
#9=#[111+#125]/#100+#3+#126*#18 (CALCULATE RADIAL OFFSET POSITION)
IF[#125EQ1]GOTO55 (IF Y-AXIS, SKIP X MOVEMENT)

N54 (X-AXIS RADIAL MOVEMENT)
G01F[#118/#100]X#9 (MOVE X TO OFFSET POSITION)
GOTO60 (PROCEED TO MEASUREMENT)

N55 (Y-AXIS RADIAL MOVEMENT)
G01F[#118/#100]Y#9 (MOVE Y TO OFFSET POSITION)

N60 (MULTI-TOOTH MEASUREMENT CHECK)
#6=#16-#129/#100 (CALCULATE Z MEASUREMENT START POSITION)
G31F[#20/#100]Z#6 (PROBE TO Z POSITION WITH MEASURING FEEDRATE)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO1 (WAIT FOR PROBE SIGNAL)
END1 (END WAIT LOOP)
#1=7 (SET ERROR CODE TO 7 - OVERTRAVEL)
IF[[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO500 (IF MEASUREMENT EXCEEDS MAX OVERTRAVEL, ERROR)
#1=6 (SET ERROR CODE TO 6 - MEASUREMENT ERROR)
IF[ABS[#5063-#16-#129/#100-#131/#100]LE[#130/100]/#100]GOTO500 (IF DIFFERENCE IN TOLERANCE, ERROR)
#16=#5063-#22 (UPDATE #16 WITH NEW MEASUREMENT)
#6=#16+#129/#100 (RECALCULATE Z POSITION)
G01F[#119/#100]Z#6 (MOVE TO NEW Z POSITION)

N80 (PROBE SINGLE TOOTH - CHECK FOR MULTI-TOOTH)
#6=#16+#129/#100 (CALCULATE Z MEASUREMENT POSITION)
G31F[#119/#100]Z#6 (PROBE TO POSITION)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO1 (WAIT FOR PROBE SIGNAL)
END1 (END WAIT LOOP)
IF[#7NE#0]GOTO91 (IF MULTI-TOOTH FLAG SET, MEASURE ALL TEETH)
IF[[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO90 (IF TOLERANCE OK, PROCEED)
#1=5 (SET ERROR CODE TO 5)
GOTO500 (ERROR HANDLER)

N90 (FINAL VERIFICATION MEASUREMENT)
#5=#16-#130/#100 (CALCULATE Z MEASUREMENT LIMIT)
G31F[#120/#100]Z#5 (PROBE AT MEASURING SPEED)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO1 (WAIT FOR PROBE SIGNAL)
END1 (END WAIT LOOP)
#1=7 (SET ERROR CODE TO 7)
IF[[#5063-#16+#130/#100-#22]LE[#130/1000]/#100]GOTO500 (IF MEASUREMENT OUT OF TOLERANCE, ERROR)
#1=6 (SET ERROR CODE TO 6)
IF[ABS[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO500 (IF TOLERANCE OK, ERROR)
#1=-1 (CLEAR ERROR CODE - SUCCESS)
GOTO100 (PROCEED TO CALCULATION)

N91 (MULTI-TOOTH MEASUREMENT INITIALIZATION)
#14=360/#7 (CALCULATE ANGLE INCREMENT BETWEEN TEETH)

N92 (MULTI-TOOTH FIRST PROBE)
M19 R[#19] (ORIENT SPINDLE TO INITIAL ANGLE)
#5=#16-#130/#100 (CALCULATE Z PROBE POSITION)
G31F[#120/#100]Z#5 (PROBE TO POSITION)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO1 (WAIT FOR PROBE SIGNAL)
END1 (END WAIT LOOP)
#23=[#5063] (STORE FIRST PROBE READING)
#26=1 (INITIALIZE TOOTH COUNTER)

N93 (MULTI-TOOTH LOOP)
WHILE[#26LT#7]DO1 (LOOP THROUGH ALL TEETH)
#19=[#19-#14] (CALCULATE NEXT SPINDLE ANGLE)
IF[#19GE-360]GOTO94 (IF ANGLE WITHIN RANGE, PROCEED)
#19=#19+360 (ADJUST ANGLE TO 0-360 RANGE)

N94 (MULTI-TOOTH PROBE NEXT TOOTH)
G01F[#118/#100]Z[#6+[[#129*5]/#100]] (MOVE Z UP FOR SPINDLE ROTATION)
M19 R#19 (ORIENT SPINDLE TO NEXT ANGLE)
G01F[#119/#100]Z#6 (MOVE Z BACK TO PROBE POSITION)
G31F[#120/#100]Z#5 (PROBE AT MEASURING SPEED)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO3 (WAIT FOR PROBE SIGNAL)
#24=[#5063] (STORE CURRENT PROBE READING)
END3 (END WAIT LOOP)
IF[#24LE#23]GOTO95 (IF CURRENT READING WORSE, CONTINUE)
#23=#24 (UPDATE TO BEST READING)
N95 (INCREMENT COUNTER)
#26=#26+1 (MOVE TO NEXT TOOTH)
END1 (END MULTI-TOOTH LOOP)
#1=7 (SET ERROR CODE TO 7)
IF[[#23-#16+#130/#100-#22]LE[#130/1000]/#100]GOTO500 (IF BEST READING OUT OF TOLERANCE, ERROR)
#1=6 (SET ERROR CODE TO 6)
IF[ABS[#23-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO500 (IF TOLERANCE OK, ERROR)
#1=-1 (CLEAR ERROR - SUCCESS)

N96 (WEAR CALCULATION - MULTI-TOOTH PATH)
#3=#141*#120/#100/60 (CALCULATE TRIGGER POINT DRIFT COMPENSATION)
#25=#23-#5043+#5023-#[#139+0]+#3 (CALCULATE TOOL LENGTH WITH WEAR FROM BEST TOOTH)
IF[#2EQ2]GOTO98 (IF WEAR COMPARISON MODE, SKIP)
IF[#2NE0]GOTO150 (IF NOT REFERENCE MODE, PROCEED)

N100 (WEAR CALCULATION - SINGLE TOOTH PATH)
#3=#141*#120/#100/60 (CALCULATE TRIGGER POINT DRIFT COMPENSATION)
#25=#5063-#5043+#5023-#[#139+0]+#3 (CALCULATE TOOL LENGTH WITH WEAR FROM PROBE)
IF[#2EQ2]GOTO105 (IF WEAR COMPARISON MODE, SKIP)
IF[#2NE0]GOTO150 (IF NOT REFERENCE MODE, PROCEED)

N150 (WEAR COMPARISON AND STORAGE)
#24=#25-#102 (CALCULATE WEAR: MEASURED - REFERENCE)
IF[#2EQ2]GOTO160 (IF WEAR COMPARISON MODE, SKIP WRITE)
IF[#136EQ0]GOTO160 (IF NO WEAR MEMORY, SKIP WRITE)
#[#136+#11]=#24 (STORE WEAR VALUE IN MEMORY)
N160 (WEAR TOLERANCE CHECK)
#1=9 (SET ERROR CODE TO 9 - TOOL BROKEN)
IF[ABS[#24]GT2*#17]GOTO500 (IF WEAR EXCEEDS 2X TOLERANCE, CRITICAL ERROR)
#1=8 (SET ERROR CODE TO 8 - OUT OF TOLERANCE)
IF[ABS[#24]GT#17]GOTO500 (IF WEAR EXCEEDS TOLERANCE, ERROR)
#1=-1 (CLEAR ERROR - SUCCESS)

N500 (ERROR HANDLER AND RETRACT)
G00G43F[#118/#100]H#11Z#10 (RAPID RETRACT Z WITH TOOL OFFSET)
G65P8917M500 (CALL O8917 MACRO - PROBE OFF SEQUENCE)
#108=#1 (STORE ERROR CODE)
G65P8917M300 (CALL O8917 MACRO - USER END PROGRAM)
IF[#1LT0]GOTO9999 (IF NO ERROR, EXIT)

N7000 (ERROR DISPLAY)
G65P8918A#1 (CALL O8918 MACRO - DISPLAY ERROR CODE)
GOTO9999 (EXIT)

N9999 (PROGRAM END)
M99 (END OF MACRO)
