(BLACKWELL ENGINEERING LLC - ETS MACRO SET)
(CALIBRATION CYCLE * V1)
(Modified: 11/2025)


#1=-1                                   (Initialize error code to -1 - no error)
G65P8917M100                            (Call machine constants subroutine)
G65P8917M200                            (Call user start program subroutine)

G40G80G90                               (Cancel cutter compensation, canned cycles, set absolute mode)

#1=1                                    (Set error code to 1 - tool number undefined)
IF[#11NE#0]GOTO2                        (If tool number H parameter is defined, skip lookup)
IF[#4111EQ0]GOTO1                       (If variable #4111 is empty, go to N1 to try #4120)
#11=#4111                               (Set tool number from variable #4111)
IF[#11NE0]GOTO2                         (If tool number is valid, proceed to N2)
N1IF[#4120EQ0]GOTO7000                  (If both #4111 and #4120 are empty, go to error)
#11=#4120                               (Set tool number from variable #4120)
N2IF[#11EQ0]GOTO7000                    (If tool number is still zero after all attempts, error)

N3                                      (Label N3 - Measurement type validation)
IF[#2EQ#0]GOTO5                         (If measurement type D parameter is undefined, go to N5)
#1=4                                    (Set error code to 4 - wrong call parameter)
IF[#2LT-1]GOTO7000                      (If D parameter is less than -1, go to error)
IF[#2GT2]GOTO7000                       (If D parameter is greater than 2, go to error)
GOTO20                                  (Go to N20 - tool length retrieval)
N5                                      (Label N5 - Set default measurement type)
#2=0                                    (Set default measurement type to 0 - reference measurement)

N20                                     (Label N20 - Tool length retrieval section)
#102=#[#134+#11]                        (Get base tool length from tool table using tool number)
#3=0                                    (Initialize wear value to 0)
IF[#136EQ0]GOTO21                       (If no wear table configured, skip wear lookup)
#3=#[#136+#11]                          (Get tool wear value from wear table)
N21#12=#102+#3                          (Calculate total tool length = base + wear)

N26                                     (Label N26 - Tool positioning and compensation setup)
#1=5                                    (Set error code to 5 - wrong tool geometry)
IF[#4008EQ49]GOTO27                     (If tool length compensation already active, skip cancel)
G00G49G91Z[#5083+#12]                   (Rapid move to clear height without compensation)
N27G53                                  (Set machine coordinate system)
G00G43G91H#11Z[-#12]                    (Rapid move with tool length compensation applied)
G90                                     (Set absolute positioning mode)
#22=#12                                 (Store current tool length for reference)

N30                                     (Label N30 - Calibration validation section)
#3=#[#139+0]                            (Get stored calibration reference value)
#3=ABS[#3-#113/#100]                    (Calculate absolute difference from reference Z position)
IF[#3LT2/#100]GOTO40                    (If calibration drift is within 2mm, proceed to N40)

N40                                     (Label N40 - Coordinate calculation section)
#3=#111/#100+#5041-#5021                (Calculate X probe position from machine coordinates and offset)
#4=#112/#100+#5042-#5022                (Calculate Y probe position from machine coordinates and offset)
#10=#127/#100+#5043-#5023-#22           (Calculate safe Z retract position)
#16=#[#139+0]+#12-#22+#5043-#5023       (Calculate normal probe contact Z position)
IF[#2NE-1]GOTO50                        (If not reference calibration mode D=-1, go to standard N50)
#16=#5023-#129/#100-#12+#5043-#5023     (Override Z for reference calibration - special setup)
#6=#16+#129/#100                        (Calculate approach position for calibration)
G65P8917M400                            (Call probe activation subroutine)
GOTO80                                  (Skip standard positioning, go directly to N80 probe)

N50                                     (Label N50 - Standard positioning section)
G40G80G90M05                            (Cancel compensation, canned cycles, set absolute, stop spindle)
M09                                     (Turn off coolant)
G01G43F[#118/#100]H#11Z#10              (Feed to safe Z position with tool compensation applied)
IF[#114EQ0]GOTO52                       (If dogleg disabled, go to combined XY move)
IF[#114EQ1]GOTO53                       (If dogleg X first, go to X move)
IF[#114EQ2]GOTO54                       (If dogleg Y first, go to Y move)
GOTO52                                  (Default to combined move if invalid)
N52                                     (Label N52 - Combined XY positioning move)
G01F[#118/#100]X#3Y#4                   (Feed to X,Y probe position in single move)
GOTO56                                  (Skip to probe activation)
N53                                     (Label N53 - Dogleg X first approach)
G01F[#118/#100]X#3                      (Feed X to probe position first)
G01F[#118/#100]Y#4                      (Feed Y to probe position second)
GOTO56                                  (Skip to probe activation)
N54                                     (Label N54 - Dogleg Y first approach)
G01F[#118/#100]Y#4                      (Feed Y to probe position first)
G01F[#118/#100]X#3                      (Feed X to probe position second)
N55                                     (Label N55 - Continue after dogleg moves)
N56                                     (Label N56 - Probe activation)

G65P8917M400                            (Call probe activation subroutine)

N61                                     (Label N51 - First probe contact move)
#5=#16+#129/#100-#12                    (Calculate first probe approach position)
G31F[#119/#100]Z#5                      (Probe move at positioning feedrate)
#3001=0                                 (Initialize skip signal status variable)
WHILE[#3001LT0.3]DO1                    (Wait for skip signal to settle - loop until stable)
END1                                    (End of stabilization loop)
IF[[#5063-#16-#129/#100]LE[#130/1000]/#100]GOTO70 (If probe contact within tolerance, go to N70)
#1=5                                    (Set error code to 5 - start measuring block error)
GOTO500                                 (Go to completion and cleanup)

N70                                     (Label N70 - Second probe contact move)
#6=#16+#129/#100                        (Calculate second probe approach position above first contact)
G31F[#119/#100]Z#6                      (Probe move at positioning feedrate)
#3001=0                                 (Initialize skip signal status variable)
WHILE[#3001LT0.3]DO1                    (Wait for skip signal to settle)
END1                                    (End of stabilization loop)
IF[[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO80 (If second probe within tolerance, go to N80)
#1=5                                    (Set error code to 5 - start measuring block error)
GOTO500                                 (Go to completion and cleanup)

N80                                     (Label N80 - Final precision probe move)
#5=#16-#130/#100                        (Calculate final probe position with overtravel allowance)
G31F[#120/#100]Z#5                      (Final probe move at measuring feedrate - slowest, most precise)
#3001=0                                 (Initialize skip signal status variable)
WHILE[#3001LT0.3]DO1                    (Wait for skip signal to settle)
END1                                    (End of stabilization loop)
#1=7                                    (Set error code to 7 - measurement without trigger signal)
IF[[#5063-#16+#130/#100-#22]LE[#130/1000]/#100]GOTO500 (Check if final probe contact within tolerance)
#1=6                                    (Set error code to 6 - error start measuring block)
IF[ABS[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO500 (Check measurement validity)
G01F[#119/#100]Z#6                      (Retract to safe Z position after measurement)

N90                                     (Label N90 - Calculate measured tool length)
#3=#141*#120/#100/60                    (Calculate trigger point correction factor)
#25=#5063-#5043+#5023-#12+#3            (Calculate measured tool length from probe signal)

N210                                    (Label N210 - Unit conversion selection)
IF[#100EQ25.4]GOTO220                   (If imperial machine conversion factor, go to N220)
#25=#25*1000                            (Convert to metric - multiply by 1000)
#25=FIX[#25]                            (Round to integer)
#25=#25/1000                            (Divide back to get 3 decimal places)
GOTO225                                 (Go to reference calibration handling)
N220                                    (Label N220 - Imperial unit conversion)
#25=#25*10000                           (Convert to imperial - multiply by 10000)
#25=FIX[#25]                            (Round to integer)
#25=#25/10000                           (Divide back to get 4 decimal places)

N225                                    (Label N225 - Reference calibration storage)
IF[#2NE-1]GOTO230                       (If not reference calibration D=-1, go to N230)
#3=#5021*#100                           (Store current X position scaled by unit factor)
#3=#3*1000                              (Multiply for precision)
#3=FIX[#3]                              (Round to integer)
#3=#3/1000                              (Divide back with rounding)
#4=#5022*#100                           (Store current Y position scaled by unit factor)
#4=#4*1000                              (Multiply for precision)
#4=FIX[#4]                              (Round to integer)
#4=#4/1000                              (Divide back with rounding)
#5=#25*#100                             (Store measured Z length scaled by unit factor)
#5=#5*1000                              (Multiply for precision)
#5=FIX[#5]                              (Round to integer)
#5=#5/1000                              (Divide back with rounding)
#111=#3                                 (Store X in reference table)
#112=#4                                 (Store Y in reference table)
#113=#5                                 (Store Z calibration reference)
#[#139+0]=#25                           (Store calibration baseline measurement)
#10=#6                                  (Set retract position to approach position)
#1=13                                   (Set completion code)
GOTO500                                 (Go to completion and cleanup)

N230                                    (Label N230 - Standard measurement comparison)
#3=#25                                  (Load measured tool length)
#3=ABS[#3-#113/#100]                    (Calculate absolute difference from reference Z)
#1=10                                   (Set error code to 10 - wrong calibration)
IF[#3GT2/#100]GOTO500                   (If difference exceeds 2mm, go to error)
IF[#2GT0]GOTO235                        (If measurement type > 0 (wear mode), go to N235)
#[#139+0]=#25                           (Store as new calibration reference)
GOTO270                                 (Go to completion)
N235                                    (Label N235 - Wear comparison mode)
IF[#2EQ2]GOTO240                        (If wear comparison only D=2, go to N240)
#[#139+0]=#25                           (Update calibration reference with new measurement)
#[#139+1]=0                             (Reset wear value to zero)
GOTO250                                 (Go to user routine call)
N240                                    (Label N240 - Wear-only calculation)
#25=#25-#[#139+0]                       (Calculate wear difference from reference)
#[#139+1]=#25                           (Store wear value)
N250                                    (Label N250 - User routine dispatch)
IF[#2EQ2]GOTO260                        (If wear comparison only D=2, go to N260)
G65P8917M600                            (Call user routine M600 - delete TC comparison)
GOTO270                                 (Go to completion)
N260                                    (Label N260 - Write TC comparison)
G65P8917M700                            (Call user routine M700 - write TC comparison)
N270                                    (Label N270 - Measurement successful)
#1=-1                                   (Set no error flag - successful measurement)

N500                                    (Label N500 - Completion and cleanup section)
IF[#2EQ-1]GOTO501                       (If reference calibration D=-1, skip retract calculation)
#10=#127/#100+#5043-#5023-#22           (Calculate standard retract position)
G01G43F[#118/#100]H#11Z#10              (Feed to retract position with tool compensation)
N501                                    (Label N501 - Probe deactivation)
G65P8917M500                            (Call probe deactivation subroutine)
#108=#1                                 (Store error code for message display)
G65P8917M300                            (Call user end program subroutine)
IF[#1LT0]GOTO9999                       (If no error, go to program end)

N7000                                   (Label N7000 - Error handling section)
G65P8918A#1                             (Call error message display subroutine)

N9999                                   (Label N9999 - Program end)
M99                                     (Return from subroutine)
