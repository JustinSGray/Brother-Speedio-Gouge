(BLACKWELL ENGINEERING - ETS)
(CALIBRATION * VERSION 1 * 01.12.2015)

#1=-1 (INITIALIZE ERROR CODE TO -1 (NO ERROR))
G65P8917M100 (CALL O8917 MACRO - MACHINE CONSTANTS)
G65P8917M200 (CALL O8917 MACRO - USER START PROGRAM)

G40G80G90 (CANCEL TOOL OFFSET, CANNED CYCLE, SET ABSOLUTE MODE)

#1=1 (SET ERROR CODE TO 1 - CALL PARAMETER H UNDEFINED)
IF[#11NE#0]GOTO2 (IF TOOL NUMBER ALREADY SET, SKIP VALIDATION)
IF[#4111EQ0]GOTO1 (IF PARAMETER #4111 NOT SET, GOTO N1)
#11=#4111 (ASSIGN TOOL NUMBER FROM #4111)
IF[#11NE0]GOTO2 (IF TOOL NUMBER NOW SET, SKIP)
N1IF[#4120EQ0]GOTO7000 (IF PARAMETER #4120 NOT SET, ERROR)
#11=#4120 (ASSIGN TOOL NUMBER FROM #4120)
N2IF[#11EQ0]GOTO7000 (IF TOOL NUMBER STILL ZERO, ERROR)

N3 (PARAMETER VALIDATION START)
IF[#2EQ#0]GOTO5 (IF #2 NOT SET, DEFAULT TO -1 (REFERENCE))
#1=12 (SET ERROR CODE TO 12 - FAULTY TABLE PARAMETER)
IF[#116LT0]GOTO7000 (IF PROBE DIAMETER NEGATIVE, ERROR)
IF[#116GT99.999]GOTO7000 (IF PROBE DIAMETER TOO LARGE, ERROR)
IF[#125LT0]GOTO7000 (IF AXIS NUMBER NEGATIVE, ERROR)
IF[#125GT1.0]GOTO7000 (IF AXIS NUMBER NOT 0 OR 1, ERROR)
IF[#126LT-1.0]GOTO7000 (IF RADIAL APPROACH SIDE INVALID, ERROR)
IF[#126GT1.0]GOTO7000 (IF RADIAL APPROACH SIDE INVALID, ERROR)
IF[#126EQ0]GOTO7000 (IF RADIAL APPROACH SIDE ZERO, ERROR)
IF[#129LT1.0]GOTO7000 (IF SAFETY DISTANCE LESS THAN 1, ERROR)
IF[#130LT1.0]GOTO7000 (IF MAX OVERTRAVEL LESS THAN 1, ERROR)
IF[#130GT5.0]GOTO7000 (IF MAX OVERTRAVEL GREATER THAN 5, ERROR)
IF[#138LT0]GOTO7000 (IF WEAR TOLERANCE NEGATIVE, ERROR)
IF[#138GT2.0]GOTO7000 (IF WEAR TOLERANCE TOO LARGE, ERROR)
IF[#139LT500]GOTO7000 (IF CALIBRATION ADDRESS LESS THAN 500, ERROR)
IF[#139GT999]GOTO7000 (IF CALIBRATION ADDRESS GREATER THAN 999, ERROR)
IF[#149LT0]GOTO7000 (IF MAX OFFSET VALUE NEGATIVE, ERROR)
IF[#149GT0.999]GOTO7000 (IF MAX OFFSET VALUE TOO LARGE, ERROR)

IF[#2EQ-1]GOTO20 (IF #2 IS -1 (REFERENCE MODE), SKIP DISTANCE CHECK)
#3=#113+#131+#129 (CALCULATE MINIMUM REQUIRED Z RANGE)
IF[#127LT#3]GOTO7000 (IF RETRACT POSITION TOO LOW, ERROR)

N20 (TOOL LENGTH CALCULATION)
#102=#[#134+#11] (READ TOOL LENGTH FROM MEMORY AT OFFSET #134+TOOL#)
#3=0 (INITIALIZE WEAR OFFSET TO 0)
IF[#136EQ0]GOTO21 (IF NO WEAR MEMORY OFFSET, SKIP WEAR READ)
#3=#[#136+#11] (READ TOOL WEAR VALUE FROM MEMORY)
N21#12=#102+#3 (CALCULATE TOTAL TOOL LENGTH WITH WEAR)

N26 (TOOL LENGTH VALIDATION)
#1=5 (SET ERROR CODE TO 5 - WRONG TOOL GEOMETRY)
IF[#12GT#131/#100]GOTO7000 (IF TOOL LENGTH EXCEEDS MAX, ERROR)
IF[#12LT#132/#100]GOTO7000 (IF TOOL LENGTH BELOW MIN, ERROR)
IF[#4008EQ49]GOTO27 (IF SPINDLE AT POSITION 49, SKIP RAPID)
G00G49G91Z[#5083+#12] (RAPID TO SAFE Z IN INCREMENTAL MODE)
N27G53 (OFFSET CANCEL)
G00G43G91H#11Z[-#12] (RAPID TO TOOL LENGTH OFFSET POSITION)
G90 (RETURN TO ABSOLUTE MODE)
#22=#12 (STORE TOOL LENGTH IN #22)

N30 (CALIBRATION OFFSET VALIDATION)
#3=#[#139+0] (READ CALIBRATION OFFSET VALUE)
#3=ABS[#3-#113/#100] (CALCULATE DEVIATION FROM REFERENCE Z)
IF[#3LT2/#100]GOTO40 (IF DEVIATION WITHIN 2 UNITS, SKIP UPDATE)
#[#139+0]=#113/#100 (UPDATE CALIBRATION OFFSET)

N40 (POSITION CALCULATION)
#3=#111/#100+#5041-#5021 (CALCULATE X POSITION: OFFSET + CURRENT - REFERENCE)
#4=#112/#100+#5042-#5022 (CALCULATE Y POSITION: OFFSET + CURRENT - REFERENCE)
#10=#127/#100+#5043-#5023-#22 (CALCULATE Z RAPID APPROACH POSITION)
#16=#[#139+0]+#12-#22+#5043-#5023 (CALCULATE MEASUREMENT Z START HEIGHT)
IF[#2NE-1]GOTO50 (IF NOT REFERENCE MODE, SKIP WEAR CALC)
#16=#5023-#129/#100-#12+#5043-#5023 (RECALCULATE Z FOR REFERENCE MEASUREMENT)
#6=#16+#129/#100 (ADD SAFETY DISTANCE TO Z)
G65P8917M400 (CALL O8917 MACRO - PROBE ON SEQUENCE)
GOTO80 (SKIP RAPID POSITIONING, PROCEED TO MEASUREMENT)

N50 (RAPID MOVEMENT SECTION)
G40G80G90M05 (CANCEL OFFSETS, CANNED CYCLES, ABSOLUTE, SPINDLE OFF)
M09 (COOLANT OFF)
G01G43F[#118/#100]H#11Z#10 (MOVE TO Z WITH TOOL OFFSET AT RAPID SPEED)
G01F[#118/#100]X#3Y#4 (MOVE X,Y TO MEASUREMENT POSITION)

G65P8917M400 (CALL O8917 MACRO - PROBE ON SEQUENCE)

N51 (FIRST PROBE MEASUREMENT)
#5=#16+#129/#100+#131/#100-#12 (CALCULATE UPPER LIMIT Z WITH SAFETY)
G31F[#119/#100]Z#5 (PROBE TO UPPER LIMIT AT POSITIONING FEEDRATE)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO1 (WAIT FOR PROBE SIGNAL)
END1 (END WAIT LOOP)
IF[[#5063-#16-#129/#100-#131/#100]LE[#130/1000]/#100]GOTO70 (IF MEASUREMENT IN TOLERANCE, PROCEED)
#1=5 (SET ERROR CODE TO 5 - PROBE SIGNAL ISSUE)
GOTO500 (ERROR HANDLER)

N70 (SECOND PROBE MEASUREMENT)
#6=#16+#129/#100 (CALCULATE Z MEASUREMENT POSITION)
G31F[#119/#100]Z#6 (PROBE AT POSITIONING FEEDRATE)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO1 (WAIT FOR PROBE SIGNAL)
END1 (END WAIT LOOP)
IF[[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO80 (IF MEASUREMENT IN TOLERANCE, PROCEED)
#1=5 (SET ERROR CODE TO 5)
GOTO500 (ERROR HANDLER)

N80 (FINAL VERIFICATION MEASUREMENT)
#5=#16-#130/#100 (CALCULATE Z MEASUREMENT LIMIT WITH OVERTRAVEL)
G31F[#120/#100]Z#5 (PROBE AT MEASURING FEEDRATE)
#3001=0 (INITIALIZE PROBE WAIT COUNTER)
WHILE[#3001LT0.3]DO1 (WAIT FOR PROBE SIGNAL)
END1 (END WAIT LOOP)
#1=7 (SET ERROR CODE TO 7 - MEAS WITHOUT TRIGGER SIGNAL)
IF[[#5063-#16+#130/#100-#22]LE[#130/1000]/#100]GOTO500 (IF OVERTRAVEL EXCEEDED, ERROR)
#1=6 (SET ERROR CODE TO 6 - ERROR START MEAS BLOCK)
IF[ABS[#5063-#16-#129/#100-#22]LE[#130/1000]/#100]GOTO500 (IF TOLERANCE OK, ERROR)
G01F[#119/#100]Z#6 (MOVE Z UP TO SAFE POSITION)

N90 (WEAR CALCULATION)
#3=#141*#120/#100/60 (CALCULATE TRIGGER POINT DRIFT COMPENSATION)
#25=#5063-#5043+#5023-#12+#3 (CALCULATE TOOL LENGTH WITH WEAR)

N210 (FORMAT CONVERSION - METRIC/IMPERIAL CHECK)
IF[#100EQ25.4]GOTO220 (IF METRIC (25.4), GOTO N220)
#25=#25*1000 (CONVERT TO THOUSANDTHS FOR IMPERIAL)
#25=FIX[#25] (ROUND DOWN TO INTEGER)
#25=#25/1000 (CONVERT BACK TO DECIMAL)
#3=#3/1000 (CONVERT BACK TO DECIMAL - X REFERENCE)
#4=#5022*#100 (GET Y REFERENCE POSITION)
#4=#4*1000 (SCALE FOR ROUNDING)
#4=FIX[#4] (ROUND TO INTEGER - Y REFERENCE)
#4=#4/1000 (CONVERT BACK TO DECIMAL - Y REFERENCE)
#5=#25*#100 (SCALE MEASURED TOOL LENGTH)
#5=#5*1000 (SCALE FOR ROUNDING)
#5=FIX[#5] (ROUND TO INTEGER)
#5=#5/1000 (CONVERT BACK TO DECIMAL - TOOL LENGTH)
#111=#3 (STORE X REFERENCE POSITION)
#112=#4 (STORE Y REFERENCE POSITION)
#113=#5 (STORE TOOL LENGTH REFERENCE)
#[#139+0]=#25 (STORE CALIBRATION VALUE)
#10=#6 (STORE SAFE Z POSITION)
#1=13 (SET ERROR CODE TO 13 - TEMP DRIFT > LIMIT)
GOTO500 (RETRACT AND END)

N230 (COMPARISON MODE VALIDATION)
#3=#25 (LOAD MEASURED VALUE)
#3=ABS[#3-#113/#100] (CALCULATE DEVIATION FROM REFERENCE)
#1=10 (SET ERROR CODE TO 10 - WRONG CAL/TC PARAMETER)
IF[#3GT2/#100]GOTO500 (IF DEVIATION TOO LARGE, ERROR)
IF[#2GT0]GOTO235 (IF #2 GREATER THAN 0, SKIP REFERENCE STORAGE)
#[#139+0]=#25 (STORE AS NEW REFERENCE)
GOTO270 (PROCEED TO CLEANUP)
N235 (COMPARISON SETUP)
IF[#2EQ2]GOTO240 (IF #2 EQUALS 2, GOTO COMPARISON)
#[#139+0]=#25 (STORE MEASURED VALUE)
#[#139+1]=0 (CLEAR WEAR COMPARISON OFFSET)
GOTO250 (PROCEED TO PROBE OFF)
N240 (WEAR COMPARISON CALCULATION)
#25=#25-#[#139+0] (CALCULATE WEAR: MEASURED - REFERENCE)
#[#139+1]=#25 (STORE WEAR OFFSET)
#1=11 (SET ERROR CODE TO 11 - TEMP DRIFT)
IF[ABS[#25]GT0.050]GOTO500 (IF WEAR EXCEEDS 0.050, ERROR)
N250 (DELETE OR WRITE WEAR VALUE)
IF[#2EQ2]GOTO260 (IF #2 EQUALS 2, WRITE COMPARISON)
G65P8917M600 (CALL O8917 MACRO - DELETE TC COMPARISON)
GOTO270 (PROCEED TO CLEANUP)
N260 (WRITE COMPARISON)
G65P8917M700 (CALL O8917 MACRO - WRITE TC COMPARISON)
N270 (SUCCESS)
#1=-1 (CLEAR ERROR CODE - SUCCESS)

N500 (ERROR/CLEANUP HANDLER)
IF[#2EQ-1]GOTO501 (IF REFERENCE MODE, SKIP RETRACT)
#10=#127/#100+#5043-#5023-#22 (CALCULATE SAFE Z RETRACT POSITION)
G01G43F[#118/#100]H#11Z#10 (RETRACT Z WITH TOOL OFFSET)
N501 (PROBE OFF AND END PROGRAM)
G65P8917M500 (CALL O8917 MACRO - PROBE OFF SEQUENCE)
#108=#1 (STORE ERROR CODE FOR DIAGNOSTICS)
G65P8917M300 (CALL O8917 MACRO - USER END PROGRAM)
IF[#1LT0]GOTO9999 (IF NO ERROR, EXIT MACRO)

N7000 (ERROR DISPLAY)
G65P8918A#1 (CALL O8918 MACRO - DISPLAY ERROR CODE)

N9999 (PROGRAM END)
M99 (END OF MACRO)
